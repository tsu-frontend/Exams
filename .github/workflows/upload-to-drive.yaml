name: Upload Folders to Google Drive

on:
  workflow_dispatch:

jobs:
  upload-folders:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with all branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch full history and all branches

      - name: Install rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/local/bin/
          rclone version

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Verify rclone remotes
        run: |
          # Confirm that the remote name (e.g. 'gdrive') matches a section in your RCLONE_CONFIG secret
          echo "Configured remotes:";
          rclone listremotes

      - name: Ensure remote directory exists
        run: |
          # Creates the target folder on the remote if it doesn't exist
          # Replace 'gdrive' with your remote name if different
          rclone mkdir tsu-frontend:github-uploaded-folders || true

      - name: Collect and upload all folders from all branches
        run: |
          OUTPUT_DIR="exams"
          mkdir -p "$OUTPUT_DIR"

          for branch in $(git branch -r | grep -v '\->' | grep -v 'HEAD'); do
            # Strip 'origin/' prefix
            CLEAN_BRANCH=${branch#origin/}
            echo "Checking out $CLEAN_BRANCH"
            git checkout -f "$CLEAN_BRANCH"

            TARGET_DIR="$OUTPUT_DIR/$CLEAN_BRANCH"
            mkdir -p "$TARGET_DIR"

            # Copy all root-level folders except .git and the output directory itself
            for folder in $(find . -maxdepth 1 -type d \
                             ! -name '.' \
                             ! -name '.git' \
                             ! -name "$OUTPUT_DIR"); do
              folder_name=$(basename "$folder")
              echo "Copying folder $folder_name from $CLEAN_BRANCH"
              cp -r "$folder" "$TARGET_DIR/"
            done
          done

          echo "Uploading to Google Drive..."
          # 'copy' will create remote paths as needed under the given folder
          # Replace 'gdrive' with your remote name if different
          rclone copy "$OUTPUT_DIR" gdrive:github-uploaded-folders
